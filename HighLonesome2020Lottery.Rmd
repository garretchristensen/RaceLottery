---
title: "High Lonesome 2020 Lottery"
author: "Garret Christensen"
date: "November 2019"
output:
  html_document: default
  pdf_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(tibble)
library(readxl)
library(checkpoint)
#checkpoint("2019-10-08")

#BEFORE DOING ANYTHING ELSE, SET THE SEED, AND SET THE ENTRY CAP
set.seed(1494) #SET THE SEED WITH DICE!
n<-150 #SET THE TOTAL NUMBER TO PICK

temp<-read.csv("./HL2020fakedata.csv", stringsAsFactors = FALSE) #LOAD THE DATA
df<-as_data_frame(temp)

```
# Background

Welcome to the High Lonesome 2020 Lottery. This lottery is run with code written by Garret Christensen. The code is available on GitHub [here](http://www.github.com/garretchristensen/RaceLottery). The intent with using Github is to make the entire process transparent and reproducible.

### Lottery Design Choices
There's no perfect design, but we have a few values we'd like to try and implement.

* We want equal numbers of men and women (statiscally this is easy)
* We'd like to get a mix of new and veteran runners, without guaranteeing entry for either
* Previous unsuccessful applications should be the major determinant of selection
* We value volunteering and trail work
* We'd like new entrants to have a decent chance to run within a couple-few years

So here are the activities for which we will award points:

* Volunteer shifts *at* High Lonesome
* Extra trailwork beyond the eight hours required
* Previous applications for the race
* Previous finishes of the race


#### Chosen Model

We've chosen the following weighting method:

* Previous unsuccesful applications. Since you were last *picked* in the lottery<!--, offered entry off the waitlist-->, or offered entry via the volunteer raffle, how many times have you entered the lottery, not including this year? Note that previous lottery entries need not be in successive years, but they reset to zero after you are picked in the lottery or are offered a slot via other means such as the volunteer raffle. 2^(n+1) tickets, where n is previous unsuccesful applications, with no maximum.

* Previous finishes. How many times have you finished High Lonesome 100?

* Volunter shifts at the previous (current calendar year at the time of the lottery) running of High Lonesome. 1 ticket per 8-hour shift, with a maximum of 2.

* Trailwork: one ticket per 8-hour shift, with a maximum of 2. Volunteering or pacing at a race doesn't count. These trailwork hours must be over and above the 8-hours required for High Lonesome itself, they must be done with an approved land management agency or partner organization, and they must not be used in order to qualify for any other race or ultra--or court-mandated community service requirement ;). We obviously don't have a great way to verify this, so you're on your honor. Please don't abuse this.  

# Implementing the Lottery
The remainder of this document summarizes the entrants and implements the lottery.


### 2020 Race Lottery Applicants

Thanks to all `r nrow(df)` who entered. 

```{r seed, echo=FALSE, results=TRUE}
#NUMBER OF MEN AND WOMEN APPLICANTS
n_men_app=nrow(men<-df[which(df$female==0),])
n_women_app=nrow(women<-df[which(df$female==1),])

#WHO HAS MORE APPLICANTS AND WOULD GET THE ODD SLOT, IF APPLICABLE?
 if (n_men_app > n_women_app) {
   largest<-"men"
 } else {
     largest<-"women"
 }

#FIRST, DO WE EVEN HAVE TO BOTHER RUNNING A LOTTERY?
if (n_men_app+n_women_app<n) {
  print ("THERE IS NO REASON TO RUN A LOTTERY! Everyone gets in!")
  n_women_pick<-n_women_app
  n_men_pick<-n_men_app
  knitr::knit_exit()
} else {

#IS THE ENTRY CAP EVEN?
#IF SO, WHICH SEX HAS MORE APPLICANTS?
#AND DO WOMEN HAVE ENOUGH APPLICANTS?
if((n %% 2) == 0) {
  #print("Entry cap is even.")
    #CAP IS EVEN
    #DO WOMEN HAVE ENOUGH APPLICANTS?
    if (n_women_app>=n/2) {
        #print("Women have enough applicants to fill their race.")
        #YES THEY DO
        n_women_pick<-n/2
        n_men_pick<-n/2
    }   else {
         #print("Women don't have enough applicants to fill their race.")
        #NO THEY DON'T, GIVE EXTRA SLOTS TO MEN
        n_women_pick<-n_women_app
        n_men_pick=n-n_women_pick
    }
} 

#IS THE ENTRY CAP ODD?
#IF SO, WHICH SEX HAS MORE APPLICANTS?
#AND DO WOMEN HAVE ENOUGH APPLICANTS? 
#NOTE WE DON'T CHECK IF MEN HAVE ENOUGH--IT'S ASSUMED.
if ((n %% 2) == 1) {
  #print("Entry cap is odd.")
  if (n_women_app>n/2) {
  #print("Women have enough applicants to fill their race.")
    
  if (n_men_app>n_women_app) {  
    #print("Men have more applicants and get the rounding slot.")
    n_men_pick<-round((n/2+.00001), digits = 0)
    n_women_pick<-round((n/2)-1, digits = 0)
  } else {
    #print("Women have at least equal applicants and get the rounding slot.")
    n_women_pick<-round((n/2+.00001), digits = 0)
    n_men_pick<-round((n/2)-1, digits = 0)
  } #END WOMEN HAVE ENOUGH
  } else {
    #print("Women don't have enough applicants to fill their race.")
    n_women_pick<-n_women_app
    n_men_pick=n-n_women_pick
  }  
}

} # END OVERALL NEED TO RUN LOTTERY
```
The seed for the pseudo-random number generator was/will be set using 6 rolls of a 10-sided die, held in public at Law's Whiskey Bar in Salida, CO on Nover 15, 2019.

The number of slots available through the lottery is: `r n`. Half the slots go to men and half to women. (If there are an odd number of slots, whichever sex has more entrants gets the extra slot, ties going to women. In our case, that's `r largest`. `r n_women_app` women applied and `r n_men_app` men applied, so we'll be picking `r n_women_pick` women and `r n_men_pick` men.)

### 2020 Race Lottery Entrants
The data file of all `r nrow(df)` entrants in the lottery, including the characteristics used in the lottery (previous finishes, previous applications, trailwork shifts, volunteer shifts) can also be found in the GitHub repository [here](http://www.github.com/garretchristensen/RaceLottery). 

Just to give you an idea, the dataset looks like this:
```{r entrants, echo=FALSE}
head(df)
```




And summary characteristics of entrants are as follows:

`r mean(df$female)*100`% Female.

Average Age: `r round(mean(df$age), digits=2)`

Average Finishes: `r round(mean(df$finishes), digits=2)`

Average Applications: `r round(mean(df$applications), digits=2)`

Average Volunteer Shifts: ???

Average Trailwork Shifts: ???

### 2020 Race Lottery Winners
The winners are listed below, and their names have been saved to CSV files, ./women_winners.csv and ./men_winners.csv. 

The mens and womens lotteries were conducted separately, with equal number of men and women chosen, except in the (unlikely, we hope!) event of fewer women entering than slots available. In that case, we reassigned extra slots to men.

The female lottery winners are:
```{r winners, echo=FALSE}

#Made ticket assignment a function in case I did it to a bunch of datasets
add<-function(df){
  df$tickets <-2^(df$Previous_Finishes) + 2^(df$Volunteer_Shifts) + 2^(df$Extra_Trailwork)+1
  return(df)
}

df<-add(df)

#SPLIT THE DATA INTO MENS AND WOMENS
men<-df[which(df$gender=="M"),]
women<-df[which(df$gender=="F"),]

#dplyr function sample_n will work with weights, normalize automatically
#syntax:sample_n(tbl, size, replace = FALSE, weight = NULL, .env = NULL, ...)
#Run the separate lotteries
women_winners<-sample_n(women, n_women_pick, replace = FALSE, weight=women$tickets)
men_winners<-sample_n(men, n_men_pick, replace = FALSE, weight=men$tickets)

#Print the winners' names
write.csv(women_winners$fullname)
```
The male lottery winners are:
```{r men, echo=FALSE}
write.csv(men_winners$fullname)
```

### 2020 Lottery Winner Characteristics

Average characteristics of the lottery winners are as follows:

HL 2020 men: `r nrow(men_winners)` total, average age `r round(mean(men_winners$Age, na.rm=TRUE), digits=1)`, previous finishes `r round(mean(men_winners$Previous_Finishes, na.rm=TRUE), digits=1)`, `r round(mean(men_winners$USA)*100, digits=0)`% USA, volunteer shifts `r round(mean(men_winners$Volunteer_Shifts, na.rm=TRUE), digits=1)`, extra trailwork `r round(mean(men_winners$Extra_Trailwork, na.rm=TRUE), digits=1)`    

HL 2020 women: `r nrow(women_winners)` total, average age `r round(mean(women_winners$Age, na.rm=TRUE), digits=1)`, previous finishes `r round(mean(women_winners$Previous_Finishes, na.rm=TRUE), digits=1)`, `r round(mean(women_winners$USA)*100, digits=0)`% USA, volunteer shifts `r round(mean(women_winners$Volunteer_Shifts, na.rm=TRUE), digits=1)`, extra trailwork `r round(mean(women_winners$Extra_Trailwork, na.rm=TRUE), digits=1)` 

The male waitlist is:

*I still need to write this.*
```{r men_waitlist, echo=FALSE}

```

The female waitlist is:

*I still need to write this.*
```{r women_waitlist, echo=FALSE}

```

